<!DOCTYPE html>
<html>
<head>
    <title>Firesphere Solr Search user/dev documentation</title>
    <link rel="stylesheet" href="/elastic-docs/main.css"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta charset="utf-8"/>
</head>

<body>
<div id="layout">
    <!-- Menu toggle -->
    <a href="#menu" id="menuLink" class="menu-link">
        <!-- Hamburger icon -->
        <span></span>
    </a>
    <nav id="menu">
        <ul>
<li><a class="" href="index.html">index</a></li>
<li><a class="" href="01-Installation.html">Installation</a></li>
<li><a class="" href="02-Elastic.html">Elastic</a></li>
<li><a class="active" href="03-Set-up-and-Configuration.html">Set up and Configuration</a></li>
<li><a class="" href="04-Searching.html">Searching</a></li>
<li><a class="" href="05-Spellcheck.html">Spellcheck</a></li>
<li class="heading"><span>Advanced Options</span></li>
<ul>
<li><a class="" href="06-Advanced-Options/01-Faceting.html">Faceting</a></li>
<li><a class="" href="06-Advanced-Options/02-Boosting.html">Boosting</a></li>
<li><a class="" href="06-Advanced-Options/03-Fuzzy-search.html">Fuzzy search</a></li>
<li><a class="" href="06-Advanced-Options/04-Elevation.html">Elevation</a></li>
<li><a class="" href="06-Advanced-Options/05-Filters-excludes.html">Filters excludes</a></li>
</ul>
<li><a class="" href="07-Customisation.html">Customisation</a></li>
<li><a class="" href="08-CMS-Usage.html">CMS Usage</a></li>
<li><a class="" href="09-Debugging.html">Debugging</a></li>
<li><a class="" href="10-Suggestions.html">Suggestions</a></li>
<li><a class="" href="11-View-Permissions.html">View Permissions</a></li>
<li><a class="" href="12-Dirty-classes.html">Dirty classes</a></li>
<li class="heading"><span>Contributing</span></li>
<ul>
<li><a class="" href="14-Contributing/01-Code-of-Conduct.html">Code of Conduct</a></li>
<li><a class="" href="14-Contributing/02-Contributing.html">Contributing</a></li>
</ul>
<li class="heading"><span>Help</span></li>
<ul>
<li><a class="" href="15-Help/01-Changelog.html">Changelog</a></li>
<li><a class="" href="15-Help/02-FAQ.html">FAQ</a></li>
<li><a class="" href="15-Help/03-Known-issues.html">Known issues</a></li>
</ul>
<li class="heading"><span>About</span></li>
<ul>
<li><a class="" href="16-About/01-About.html">About</a></li>
<li><a class="" href="16-About/02-Plans.html">Plans</a></li>
<li class="heading"><span>Codebase</span></li>
<ul>
<li><a class="" href="16-About/03-Codebase/01-Main-stats.html">Main stats</a></li>
</ul>
</ul>
</ul>
    </nav>
    <article id="main" class="content">
        <h1 id="set-up-and-configuration">Set-up and configuration <a class="heading-anchor-permalink" href="#set-up-and-configuration">#</a></h1>
<h2 id="getting-started">Getting started <a class="heading-anchor-permalink" href="#getting-started">#</a></h2>
<p>In order to return search results, Elastic requires an Index that holds the searchable data.
So the first thing you <em>need</em> to do is to create an index extending the
<code>Firesphere\ElasticSearch\Indexes\ElasticIndex</code> class.</p>
<p>If you are extending the base Index, it will require a <code>getIndexName</code> method
which is used to determine the name of the index to query Elastic.</p>
<p><strong>IMPORTANT</strong></p>
<p>The usage of <code>YML</code> for the core configuration is <em>not</em> a replacement for creating your own Index
extending either of the Base Indexes; it is a complement to it.</p>
<p><code>YML</code> is purely used for the configuration of the index Classes.</p>
<h2 id="configuration">Configuration <a class="heading-anchor-permalink" href="#configuration">#</a></h2>
<p>Configuring Elastic is done via YML:</p>
<pre><code class="language-yaml">Firesphere\ElasticSearch\Services\ElasticCoreService:
  config:
    endpoint:
      myhostname:
        host: myhost.com
        port: 9200
        username: MyUsername
        password: MyPassword
        # set up timeouts
  # default path settings
  debug: false
</code></pre>
<h3 id="authentication">Authentication <a class="heading-anchor-permalink" href="#authentication">#</a></h3>
<p>Elastic supports several ways of adding authentication to the instance.</p>
<p>The module supports Basic Authentication or APIKey, which can be added in the YML config like so:</p>
<pre><code class="language-yaml">Firesphere\ElasticSearch\Services\ElasticCoreService:
  config:
    endpoint:
      myhostname:
        username: Elastic
        password: ElasticRocks
        apiKey: MyBase64EncodedApiKeyHere===
</code></pre>
<h3 id="debug">Debug <a class="heading-anchor-permalink" href="#debug">#</a></h3>
<p>You can force the debugging to false, by setting the debug flag. If you omit this tag, CLI and Dev mode
will have debugging enabled.</p>
<h4 id="showinsearch">ShowInSearch <a class="heading-anchor-permalink" href="#showinsearch">#</a></h4>
<p><code>ShowInSearch</code> is handled by the module itself, so there is no need to configure it within your YML/PHP index definition.
When a content author sets this field to <code>0</code> via the CMS, then the related Page or File object is actually <em>removed</em> from the applicable Elastic
core immediately through the <code>onAfterPublish</code> or <code>onAfterWrite</code> method, or during the next run of the <code>ElasticIndexJob</code>.</p>
<p>Therefore, custom addition of <code>ShowInSearch</code> as a filterable or indexable field in YML
is likely to cause unexpected behaviour.</p>
<p>The reason for removing <code>ShowInSearch = false|0</code> from the indexing process,
is to streamline the number of items stored in Elastic’s indexes.
There is no effective need for items to be in the search, if they’re not supposed to
be displayed.</p>
<h4 id="dirty-classes">Dirty classes <a class="heading-anchor-permalink" href="#dirty-classes">#</a></h4>
<p><em>NOTE</em> This is currently unfinished</p>
<p>If a change fails to update, a <code>DirtyClass</code> is created, recording the need for updating
said object. It is recommended to automatically run the <code>ClearDirtyClasses</code> task every few hours
depending on the expected amount of changes daily and the importance of those changes.</p>
<p>The expected time to run the task is quite low, so we recommend running this task reasonably
often (every 5 or 10 minutes).</p>
<h3 id="using-yml">Using YML <a class="heading-anchor-permalink" href="#using-yml">#</a></h3>
<pre><code class="language-yaml">Firesphere\ElasticSearch\Indexes\ElasticIndex:
  MySearchIndex:
    Classes:
      - SilverStripe\CMS\Model\SiteTree
    FulltextFields:
      - Content
      - TestObject.Title
      - TestObject.TestRelation.Title
    SortFields: 
	  - Created
    FilterFields:
      - Title
      - Created
      - Firesphere\ElasticSearch\Tests\TestObject
    BoostedFields:
	  - Title
    FacetFields:
      Firesphere\ElasticSearch\Tests\TestObject:
        BaseClass: SilverStripe\CMS\Model\SiteTree
        Field: ID
        Title: TestObject

</code></pre>
<p><strong>NOTE</strong> Facets are on to-do</p>
<h4 id="mysearchindex">MySearchIndex <a class="heading-anchor-permalink" href="#mysearchindex">#</a></h4>
<p>This name should match the name you provided in your Index extending the <code>ElasticIndex</code> you are instructed
to create in the first step of this document.</p>
<h2 id="grouped-indexing">Grouped indexing <a class="heading-anchor-permalink" href="#grouped-indexing">#</a></h2>
<p>Be aware that Grouped indexing is <code>0</code>-based. Thus, if there are 150 groups to index,
the final group to index will be 149 instead of 150.</p>
<h2 id="method-output-casting">Method output casting <a class="heading-anchor-permalink" href="#method-output-casting">#</a></h2>
<p>To get the correct Elastic field type in the Elastic Configuration, you will need to add a
casting for each method you want to add. So for the <code>Content</code> field, the method below:</p>
<pre><code class="language-php">public function getContent()
{
    return $renderedContent;
}
</code></pre>
<p>Could have a casting like the below to ensure it renders as HTML:</p>
<pre><code class="language-php">private static $casting = [
    'getContent' =&gt; 'HTMLText',
    'Content'    =&gt; 'HTMLText'
];
</code></pre>
<p>Depending on your field definition, you either need to have the full method name, or the short method name.</p>
<h2 id="another-way-to-set-the-config-in-php">Another way to set the config in PHP <a class="heading-anchor-permalink" href="#another-way-to-set-the-config-in-php">#</a></h2>
<p>You could also use PHP to set the config. For readability however, it’s better to use variables for Facets:</p>
<pre><code class="language-php">    protected $facetFields = [
        RelatedObject::class   =&gt; [
            'BaseClass' =&gt; SiteTree::class,
            'Field'     =&gt; 'RelatedObjectID',
            'Title'     =&gt; 'RelationOne'
        ],
        OtherRelatedObject::class =&gt; [
            'BaseClass' =&gt; SiteTree::class,
            'Field'     =&gt; 'OtherRelatedObjectID',
            'Title'     =&gt; 'RelationTwo'
        ]
    ];
</code></pre>
<p>This will generate a facet field in Elastic, assuming this relation exists on <code>SiteTree</code> or <code>Page</code>.</p>
<p>The relation would look like <code>SiteTree.RelatedObjectID</code>, where <code>RelatedObject</code> the name of the relation reflects.</p>
<p>The Title is used to group all facets by their Title, in the template, this is accessible by looping <code>$Result.FacetSet.TitleOfTheFacet</code></p>
<h3 id="important-notice">Important notice <a class="heading-anchor-permalink" href="#important-notice">#</a></h3>
<p>Facets are relational. For faceting on a relation, omit the origin class (e.g. <code>SiteTree</code>), but supply the full relational
path to the facet. e.g. if you want to have facets on <code>RelationObject-&gt;ManyRelation()-&gt;OneRelation()-&gt;ID</code>, the Facet declaration should be
<code>ManyRelationObject.OneRelationID</code>, assuming it’s a <code>has_one</code> relation.</p>
<p>If you have many relations, through either <code>many_many</code> or <code>has_many</code>, your definition should
use <code>ManyRelationObjectName.Relation.ID</code> instead of <code>RelationID</code>. It works and resolves the same.</p>
<p>It is strongly advised to use relations for faceting, as Elastic tends to think of textual relations in a different way.</p>
<h4 id="example">Example <a class="heading-anchor-permalink" href="#example">#</a></h4>
<p>If you set relations on <code>MyObject.TextField</code>, and the text field contains “Content Name
One” and “Content Name Two”, faceting would be done in such a way that “Content”, “Name”
and “One” would be three different facet results, rather than “Content Name One”.</p>
<h2 id="accessing-elastic">Accessing Elastic <a class="heading-anchor-permalink" href="#accessing-elastic">#</a></h2>
<p>If available, you can access your Elastic instance via Kibana, at <code>http://mydomain.com:5601</code></p>
<h2 id="excluding-unwanted-indexes">Excluding unwanted indexes <a class="heading-anchor-permalink" href="#excluding-unwanted-indexes">#</a></h2>
<p>To exclude unwanted indexes, it is possible declare a list of <em>wanted</em> indexes in the <code>YML</code></p>
<pre><code class="language-yaml">Firesphere\ElasticSearch\Services\ElasticCoreService:
  indexes:
    - CircleCITestIndex
    - Firesphere\ElasticSearch\Tests\TestIndex
    - Firesphere\ElasticSearch\Tests\TestIndexTwo
    - Firesphere\ElasticSearch\Tests\TestIndexThree
</code></pre>
<p>Looking at the <code>tests</code> folder, there is a <code>TestIndexFour</code>. This index is not loaded unless explicitly asked.</p>

        <hr/>
        <h2>Support our work</h2>
        <p>
            <a href='https://ko-fi.com/B0B11GKLY' target='_blank'>
                <img height='36' style='border:0px;height:36px;' src='https://az743702.vo.msecnd.net/cdn/kofi2.png?v=2'
                     border='0' alt='Buy Me a Coffee at ko-fi.com'/>
            </a>
        </p>
    </article>
</div>
<noscript><p><img src="https://piwik.casa-laguna.net/matomo.php?idsite=13&amp;rec=1" style="border:0;" alt=""/></p>
</noscript>
<script src="/elastic-docs/main.js"></script>
<script src="https://cdn.rawgit.com/google/code-prettify/master/loader/run_prettify.js"></script>
</body>
</html>
